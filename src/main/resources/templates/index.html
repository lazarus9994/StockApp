<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en"
      th:replace="~{layout :: layout(~{::body})}">
<body>

<section class="dashboard">
    <h1 class="page-title">üìä Dashboard Overview</h1>
    <p class="page-subtitle">Your personalized stock insights and market performance</p>

    <!-- === Filter Form === -->
    <div style="margin-bottom: 20px;">
        <form id="rangeForm" style="display:flex; gap:10px;">
            <select id="rangeSelect" name="range">
                <option value="daily" th:selected="${range == 'daily'}">1 Day</option>
                <option value="weekly" th:selected="${range == 'weekly'}">1 Week</option>
                <option value="monthly" th:selected="${range == 'monthly'}">1 Month</option>
                <option value="yearly" th:selected="${range == 'yearly'}">1 Year</option>
                <option value="all" th:selected="${range == 'all'}">All Time</option>
            </select>
        </form>

    </div>


    <!-- === Dashboard Grid === -->
    <div class="dashboard-grid">

        <!-- === Market Chart === -->
        <div class="card wide" style="height: 380px;">
            <h3 th:text="'NASDAQ (' + ${range} + ')'">Market Chart</h3>
            <canvas id="marketChart" style="width:100%;height:300px;"></canvas>
        </div>


        <!-- === Watchlist === -->
        <div class="card">
            <h3>
                <a th:href="@{/watchlist}" style="text-decoration:none; color:inherit;">Your Watchlist</a>
            </h3>

            <ul>
                <li th:if="${#lists.isEmpty(watchlist)}">
                    <em>No items in your watchlist yet.</em>
                </li>

                <li th:each="item : ${watchlist}">
                    <span th:text="${item.stock.stockCode}">AAPL</span> ‚Äî
                    <span th:text="${item.stock.stockName}">Apple Inc.</span>
                    <span th:if="${changes != null and item.stock != null and changes[item.stock.stockCode] != null}"
                          th:text="${#numbers.formatDecimal(changes[item.stock.stockCode], 1, 2)} + '%'"
                          th:classappend="${changes[item.stock.stockCode] > 0 ? 'green' : (changes[item.stock.stockCode] < 0 ? 'red' : '')}">
                    </span>

                    <span th:if="${changes == null or changes[item.stock.stockCode] == null}">‚Äî</span>

                </li>
            </ul>
        </div>


        <!-- === News === -->
        <div class="card wide">
            <h3>Latest Market News</h3>
            <ul>
                <li><strong>NASDAQ</strong> hits record high driven by AI sector growth.</li>
                <li><strong>Oil prices</strong> dip 2% amid global demand concerns.</li>
                <li><strong>Tech stocks</strong> recover after last week‚Äôs dip.</li>
            </ul>
        </div>
    </div>
</section>

<!-- === Chart.js === -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ctx = document.getElementById("marketChart").getContext("2d");
        let marketChart = null;

        const rangeSelect = document.getElementById("rangeSelect");
        const currentRange = new URLSearchParams(window.location.search).get("range") || "monthly";

        // –∑–∞—Ä–µ–∂–¥–∞–º–µ –Ω–∞—á–∞–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω–∏
        loadChartData(currentRange);

        // –ø—Ä–∏ –ø—Ä–æ–º—è–Ω–∞ –Ω–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
        rangeSelect.addEventListener("change", (e) => {
            const range = e.target.value;
            loadChartData(range);
            const params = new URLSearchParams(window.location.search);
            params.set("range", range);
            history.replaceState(null, "", "?" + params.toString());
        });

        async function loadChartData(range) {
            try {
                console.log("üîÑ Loading chart for", range);
                const res = await fetch(`/api/chart?range=${range}`);
                if (!res.ok) throw new Error("HTTP " + res.status);
                const records = await res.json();

                const labels = records.map(r => new Date(r.date));
                const data = records.map(r => Number(r.close ?? 0));

                const timeUnit = ({
                    daily: "day",
                    weekly: "week",
                    monthly: "month",
                    yearly: "year",
                    all: "year"
                })[range] || "month";

                // —É–Ω–∏—â–æ–∂–∞–≤–∞–º–µ —Å—Ç–∞—Ä–∞—Ç–∞ –≥—Ä–∞—Ñ–∏–∫–∞, –∞–∫–æ –∏–º–∞ —Ç–∞–∫–∞–≤–∞
                if (marketChart && typeof marketChart.destroy === "function") {
                    marketChart.destroy();
                }

                marketChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels,
                        datasets: [{
                            label: "NDAQ",
                            data,
                            borderColor: "#58a6ff",
                            backgroundColor: "rgba(88,166,255,0.1)",
                            tension: 0.3,
                            pointRadius: 0,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: "time",
                                time: { unit: timeUnit },
                                ticks: { color: "#8b949e" },
                                grid: { color: "#21262d" }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: { color: "#8b949e" },
                                grid: { color: "#21262d" }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: ctx => `Close: $${ctx.parsed.y?.toFixed(2) ?? "N/A"}`
                                }
                            }
                        }
                    }
                });

                console.log(`üìä Loaded ${records.length} records for NDAQ (${range})`);
            } catch (err) {
                console.error("‚ùå Chart load failed:", err);
            }
        }
    });
</script>


</body>
</html>
